<html><head><meta http-equiv="Content-Type"content="text/html; charset=utf-8"/><title>优化你的服务器 SWAP (内核调优)</title><link rel="stylesheet" type="text/css" href="http://chengshuguang.com/blog/css/global.css" /><link rel="stylesheet" href="http://chengshuguang.com/blog/highlight/styles/rainbow.css"><script src="http://chengshuguang.com/blog/script/jquery.js" type="text/javascript"></script><script src="http://chengshuguang.com/blog/highlight/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><h1><center>优化你的服务器 SWAP (内核调优) </center></h1><h3>先来个案例</h3><p>今天一个同学问我，他的一个程序跑着跑着，中途会出现一个进程kswapd7，导致程序会卡住。 下面就这个问题来分析分析。首先我们看看kswapd这个进程</p><blockquote>kswapd(Kernel Swap Daemon)是用来处理页面的交换的内核守护进程，它可以在内存不足时，将一些进程的页面交换到swap空间之中。</blockquote> <p>问题当然不会仅仅是内存不足这么简单，他的机器64G内存，还剩20G空闲，按理说，不会出现内存不足啊。为什么会导致内存拼命的swap呢？</p><hr><h3>问题分析</h3><p>本人第一感觉是，会不会管理员限制了你用户的内存最大可用值呢？可是人家是root用户啊，并没有这种限制啊。这个原因可以排除掉。然后就想着会不会有什么内核参数，控制着swap的交换，果然，给我发现了新大陆，可以通过<code>调节swappiness内核参数降低系统对swap的使用</code>。原来内核并不是在内存用完后才会开始使用swap把内存换到外存，而是由swappiness这个参数控制着。</p><blockquote><p><center>Swappiness is a Linux kernel parameter that controls the relative weight given to swapping out runtime memory, as opposed to dropping pages from the system page cache. </center></p></blockquote><p>root用户打开<code>/etc/sysctl.conf</code>参看你的vm. swappiness的值。</p><p>swappiness的值[0,100], 比如在ubuntu中默认vm.swappiness = 60. <code>表示60%的内存已使用后，开始使用swap。</code></p><h3>问题解决</h3><p>由上面的分析，前面的案例，那个同学的机器默认的vm.swappiness=60, 已用内存44/64=68.75% &gt; 60% 。那么swap已经开始工作了，所以会看到kswapd7进程出现，大量内存被交换到外存。</p><h3>修改swappniess</h3><p>我看了下我在阿里云上面的服务器，vm.swappiness默认设置的为0，<code>注意: 0 并不是表示禁止swap，当out of memory的时候，还是会使用swap，也就是不到万不得已，不会使用swap。</code>。当然你可以不设置为0，一般来说，经常设置为1, 10。修改后通过下面命令直接动态加载/etc/sysctl.conf使生效。</p><pre><code>sysctl&nbsp;-p</pre></code><p>当然，动态加载的话，你首先还需要把swap中得内容给交换到内存里面去。用如下命令。</p><pre><code>swapoff&nbsp;-a&nbsp;&&&nbsp;swapon&nbsp;-a&nbsp;//把swap关闭后再重启。</pre></code><h1>总结</h1><p>一般服务器上，我们需要调整vm. swappiness的值，比如Ubuntu的默认值60，这样在大内存需求的情况下，会导致swap大量出现，导致性能下降。<code>我们根据业务需求，尽量调小swappiness的值，减少swap</code>。</p><a href="https://github.com/codercheng/"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://chengshuguang.com/pic_res/fork_me_on_github.png" alt="Fork me on GitHub" data-canonical-src="http://chengshuguang.com/pic_res/fork_me_on_github.png"></a></body></html>
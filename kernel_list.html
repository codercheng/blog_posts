<html><head><meta http-equiv="Content-Type"content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="http://chengshuguang.com/blog/css/global.css" /><link rel="stylesheet" href="http://chengshuguang.com/blog/highlight/styles/rainbow.css"><script src="http://chengshuguang.com/blog/script/jquery.js" type="text/javascript"></script><script src="http://chengshuguang.com/blog/highlight/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><h1><center>Linux kernel中链表的实现</center></h1><p>kernel中链表实现的实在是精妙，赶紧记下来。下面将会介绍下其精妙的实现：</p><hr><h3>前言</h3><p>Linux内核中链表的实现不同于我们平常教科书中得实现方法。我们上课时学到的链表很简单，这里也不再介绍，但是其有一个很大的缺点，就是不可复用，不容易扩展(例如：你需要学生信息组成一个链表，还需要书本信息组成另一链表，传统的链表你无法复用，需要定义两个不同的链表Node)。但是，kernel中链表能够做到<code>可复用性</code>，下面具体分析。</p><h3>实现</h3><p>kernel中链表定义在<code>include/linux/list.h</code>中， 是一个双循环链表。其不同之处在于，<code>它不是将数据结构塞入链表，而是把链表结点塞入数据结构</code>。直接上图:<code>(上:普通链表；下:内核链表)</code></p><p><center> <img src="pic/kernel_list.png"/><img src="pic/kernel_list_2.png"/></center></p><p>上面是普通链表和内核中链表的示意图(上:普通链表；下:内核链表)，看出不同了么？最大的不同就是普通链表指向的是整个struct结构体(数据结构塞入链表)，而内核的链表指向的可是一个只包含next,prev指针的结构体（即，整个struct结构的一个成员。）(链表结点塞入数据结构)。这就是为什么内核中得链表可以复用了。</p><p>那么问题来了，由于内核链表中没有包含其它的数据成员，那么<code>怎么根据next/prev指向的结构得到整个结构体呢？</code></p><p>首先给出这个可以复用的链表Node：</p><pre><code>struct&nbsp;list_head&nbsp;{<br/>&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;list_head&nbsp;*next,&nbsp;*prev;<br/>};</pre></code><p>直接在你需要组成链表的struct中添加struct list_head node就可以了。比如：</p><pre><code>struct&nbsp;student&nbsp;{<br/>	int&nbsp;sid;<br/>	char&nbsp;name[256];<br/><br/> /*&nbsp;链表节点&nbsp;*/<br/>	struct&nbsp;list_head&nbsp;node;<br/>};</pre></code><p>现在来解决上面提到的问题:怎么根据结构题的一个成员来得到整个结构题呢？kernel中实现用到了container_of宏，这个宏可以解决这个问题，那么所用问题就迎刃而解了。关于container_of的详细介绍，请移步 <a href="http://chengshuguang.com/blog/posts/container_of.html">详解内核中的container_of宏</a></p><h3>其他</h3><p>本文只讲解了kernel中如何实现链表的精妙，具体链表的操作方法实现不在这作介绍，请移步 <a href="https://www.ibm.com/developerworks/cn/linux/kernel/l-chain/">深入分析 Linux 内核链表</a>，这里面对链表的每个方法都讲得比较清楚。</p><a href="https://github.com/codercheng/"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://chengshuguang.com/pic_res/fork_me_on_github.png" alt="Fork me on GitHub" data-canonical-src="http://chengshuguang.com/pic_res/fork_me_on_github.png"></a></body></html>